import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';

export interface Quiz {
  id: string;
  name: string;
  enabled: boolean;
  questions: number;
  language: string;
  continent: string;
  route: string;
}

export interface QuizConfig {
  name: string;
  questions: number;
  languages: string[]; // Changed from language to languages array
  continent: string;
}

@Injectable({
  providedIn: 'root'
})
export class AdminService {
  private availableQuizzes = new BehaviorSubject<Quiz[]>([]);
  public quizzes$ = this.availableQuizzes.asObservable();

  constructor() {
    this.loadQuizzes();
  }

  private loadQuizzes(): void {
    const savedQuizzes = localStorage.getItem('quiz-available-quizzes');
    
    if (savedQuizzes) {
      this.availableQuizzes.next(JSON.parse(savedQuizzes));
    } else {
      // Quiz par défaut - 3 types principaux
      const defaultQuizzes: Quiz[] = [
        // Quiz rapides
        {
          id: 'world',
          name: 'Quiz Monde Complet',
          enabled: true,
          questions: 30,
          language: 'Toutes langues',
          continent: 'Tous les drapeaux du monde',
          route: 'quiz/world'
        },
        {
          id: 'europe-quick',
          name: 'Quiz Europe Express',
          enabled: true,
          questions: 20,
          language: 'Toutes langues',
          continent: 'Europe uniquement',
          route: 'quiz/europe'
        },
        {
          id: 'francophone-quick',
          name: 'Quiz Pays Francophones',
          enabled: true,
          questions: 15,
          language: 'Français',
          continent: 'Pays francophones',
          route: 'quiz/francophone'
        },
        // Options personnalisées
        {
          id: 'continent-custom',
          name: 'Quiz Continents Personnalisé',
          enabled: true,
          questions: 20,
          language: 'Toutes langues',
          continent: 'Sélection personnalisée',
          route: 'continent-selection'
        },
        {
          id: 'language-custom',
          name: 'Quiz Langues Personnalisé',
          enabled: true,
          questions: 25,
          language: 'Sélection personnalisée',
          continent: 'Selon langues choisies',
          route: 'language-selection'
        }
      ];
      
      this.availableQuizzes.next(defaultQuizzes);
      this.saveQuizzes(defaultQuizzes);
    }
  }

  private saveQuizzes(quizzes: Quiz[]): void {
    localStorage.setItem('quiz-available-quizzes', JSON.stringify(quizzes));
  }

  getEnabledQuizzes(): Quiz[] {
    return this.availableQuizzes.value.filter(quiz => quiz.enabled);
  }

  getAllQuizzes(): Quiz[] {
    return this.availableQuizzes.value;
  }

  toggleQuizStatus(quizId: string): void {
    const quizzes = this.availableQuizzes.value;
    const quizIndex = quizzes.findIndex(q => q.id === quizId);
    
    if (quizIndex !== -1) {
      quizzes[quizIndex].enabled = !quizzes[quizIndex].enabled;
      this.availableQuizzes.next([...quizzes]);
      this.saveQuizzes(quizzes);
    }
  }

  enableQuiz(quizId: string): void {
    this.setQuizStatus(quizId, true);
  }

  disableQuiz(quizId: string): void {
    this.setQuizStatus(quizId, false);
  }

  private setQuizStatus(quizId: string, enabled: boolean): void {
    const quizzes = this.availableQuizzes.value;
    const quizIndex = quizzes.findIndex(q => q.id === quizId);
    
    if (quizIndex !== -1) {
      quizzes[quizIndex].enabled = enabled;
      this.availableQuizzes.next([...quizzes]);
      this.saveQuizzes(quizzes);
    }
  }

  addNewQuiz(config: QuizConfig): Quiz {
    const newQuiz: Quiz = {
      id: this.generateQuizId(config.name),
      name: config.name,
      enabled: true,
      questions: config.questions,
      language: config.languages.join(', '), // Join multiple languages
      continent: config.continent,
      route: `quiz/${this.generateQuizId(config.name)}`
    };

    const quizzes = this.availableQuizzes.value;
    const updatedQuizzes = [...quizzes, newQuiz];
    
    this.availableQuizzes.next(updatedQuizzes);
    this.saveQuizzes(updatedQuizzes);

    return newQuiz;
  }

  removeQuiz(quizId: string): boolean {
    const quizzes = this.availableQuizzes.value;
    const filteredQuizzes = quizzes.filter(q => q.id !== quizId);
    
    if (filteredQuizzes.length !== quizzes.length) {
      this.availableQuizzes.next(filteredQuizzes);
      this.saveQuizzes(filteredQuizzes);
      return true;
    }
    
    return false;
  }

  getQuizById(quizId: string): Quiz | null {
    return this.availableQuizzes.value.find(q => q.id === quizId) || null;
  }

  private generateQuizId(name: string): string {
    return name
      .toLowerCase()
      .replace(/[^a-z0-9]/g, '_')
      .replace(/_+/g, '_')
      .replace(/^_|_$/g, '');
  }

  // Méthodes pour les options disponibles dans les formulaires
  getAvailableLanguages(): string[] {
    return [
      'Toutes langues',
      'Français',
      'Anglais',
      'Espagnol',
      'Allemand',
      'Italien',
      'Portugais',
      'Arabe',
      'Chinois',
      'Russe'
    ];
  }

  getAvailableContinents(): string[] {
    return [
      'Tous continents',
      'Europe',
      'Asie',
      'Afrique',
      'Amérique du Nord',
      'Amérique du Sud',
      'Océanie',
      'Antarctique'
    ];
  }

  // Validation des données de quiz
  validateQuizConfig(config: QuizConfig): { valid: boolean; errors: string[] } {
    const errors: string[] = [];

    if (!config.name || config.name.trim().length < 3) {
      errors.push('Le nom du quiz doit contenir au moins 3 caractères');
    }

    if (config.questions < 5 || config.questions > 50) {
      errors.push('Le nombre de questions doit être entre 5 et 50');
    }

    if (!config.languages || config.languages.length === 0) {
      errors.push('Veuillez sélectionner au moins une langue');
    }

    if (!config.continent) {
      errors.push('Veuillez sélectionner un continent');
    }

    // Vérifier si un quiz avec le même nom existe déjà
    const existingQuiz = this.availableQuizzes.value.find(
      q => q.name.toLowerCase() === config.name.trim().toLowerCase()
    );
    
    if (existingQuiz) {
      errors.push('Un quiz avec ce nom existe déjà');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }

  // Méthode pour forcer la réinitialisation des quiz par défaut
  resetToDefaultQuizzes(): void {
    localStorage.removeItem('quiz-available-quizzes');
    
    // Recréer les quiz par défaut
    const defaultQuizzes: Quiz[] = [
        // Quiz rapides
        {
          id: 'world',
          name: 'Quiz Monde Complet',
          enabled: true,
          questions: 30,
          language: 'Toutes langues',
          continent: 'Tous les drapeaux du monde',
          route: 'quiz/world'
        },
        {
          id: 'europe-quick',
          name: 'Quiz Europe Express',
          enabled: true,
          questions: 20,
          language: 'Toutes langues',
          continent: 'Europe uniquement',
          route: 'quiz/europe'
        },
        {
          id: 'francophone-quick',
          name: 'Quiz Pays Francophones',
          enabled: true,
          questions: 15,
          language: 'Français',
          continent: 'Pays francophones',
          route: 'quiz/francophone'
        },
        // Options personnalisées
        {
          id: 'continent-custom',
          name: 'Quiz Continents Personnalisé',
          enabled: true,
          questions: 20,
          language: 'Toutes langues',
          continent: 'Sélection personnalisée',
          route: 'continent-selection'
        },
        {
          id: 'language-custom',
          name: 'Quiz Langues Personnalisé',
          enabled: true,
          questions: 25,
          language: 'Sélection personnalisée',
          continent: 'Selon langues choisies',
          route: 'language-selection'
        }
      ];
      
      this.availableQuizzes.next(defaultQuizzes);
      this.saveQuizzes(defaultQuizzes);
    }
  }

  private saveQuizzes(quizzes: Quiz[]): void {
    localStorage.setItem('quiz-available-quizzes', JSON.stringify(quizzes));
  }

  getQuizzes(): Quiz[] {
    return this.availableQuizzes.value;
  }

  getQuizByType(type: string): Quiz | undefined {
    const quizzes = this.availableQuizzes.value;
    
    // Mappage des types d'URL vers les IDs de quiz
    const typeMapping: { [key: string]: string } = {
      'world': 'world',
      'europe': 'europe-quick', 
      'francophone': 'francophone-quick',
      'continent-custom': 'continent-custom',
      'language-custom': 'language-custom'
    };
    
    const quizId = typeMapping[type] || type;
    return quizzes.find(quiz => quiz.id === quizId);
  }

  updateQuiz(updatedQuiz: Quiz): void {
    const quizzes = this.availableQuizzes.value;
    const index = quizzes.findIndex(q => q.id === updatedQuiz.id);
    
    if (index !== -1) {
      quizzes[index] = updatedQuiz;
      this.availableQuizzes.next([...quizzes]);
      this.saveQuizzes(quizzes);
    }
  }

  addQuiz(newQuiz: Quiz): void {
    const quizzes = this.availableQuizzes.value;
    quizzes.push(newQuiz);
    this.availableQuizzes.next([...quizzes]);
    this.saveQuizzes(quizzes);
  }

  deleteQuiz(quizId: string): void {
    const quizzes = this.availableQuizzes.value;
    const filteredQuizzes = quizzes.filter(q => q.id !== quizId);
    this.availableQuizzes.next(filteredQuizzes);
    this.saveQuizzes(filteredQuizzes);
  }

  resetToDefaultQuizzes(): void {
    localStorage.removeItem('quiz-available-quizzes');
    this.loadQuizzes();
  }
}